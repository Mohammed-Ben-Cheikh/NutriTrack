<% const profileData=typeof profile !=='undefined' && profile ? profile : {}; const tailleCm=profileData.taille_cm;
  const poidsActuel=profileData.poids_actuel_kg; const poidsCible=profileData.poids_cible_kg; const
  caloriesCible=profileData.calories_cible; const objectifPrincipal=profileData.objectif; const
  activityLevel=profileData.niveau_activite; const sportDiscipline=profileData.sport_discipline; const imcValue=tailleCm
  && poidsActuel ? (poidsActuel / Math.pow(tailleCm / 100, 2)).toFixed(1) : null; %>


  <div class="mb-6">
    <h2 class="text-2xl font-bold text-gray-900">
      Profil nutritionnel
    </h2>
    <p class="text-gray-600">Personnalisez vos données pour des recommandations adaptées.</p>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">Calories cibles</p>
          <p class="text-2xl font-bold text-gray-900">
            <%= caloriesCible ? caloriesCible + ' kcal' : '--' %>
          </p>
        </div>
        <div class="p-3 bg-indigo-100 rounded-full">
          <i class="fas fa-fire text-indigo-600 text-xl"></i>
        </div>
      </div>
      <p class="mt-4 text-xs text-gray-500">
        Objectif quotidien personnalisé
      </p>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">Poids actuel</p>
          <p class="text-2xl font-bold text-gray-900">
            <%= poidsActuel ? poidsActuel + ' kg' : '--' %>
          </p>
          <% if (poidsCible) { %>
            <p class="text-xs text-gray-500 mt-1">Objectif: <%= poidsCible %> kg</p>
            <% } %>
        </div>
        <div class="p-3 bg-purple-100 rounded-full">
          <i class="fas fa-weight text-purple-600 text-xl"></i>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">IMC estimé</p>
          <p class="text-2xl font-bold text-gray-900">
            <%= imcValue ? imcValue : '--' %>
          </p>
        </div>
        <div class="p-3 bg-green-100 rounded-full">
          <i class="fas fa-heartbeat text-green-600 text-xl"></i>
        </div>
      </div>
      <p class="mt-4 text-xs text-gray-500">
        Calculé à partir de votre taille et poids
      </p>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">Objectif principal</p>
          <p class="text-2xl font-bold text-gray-900">
            <%= objectifPrincipal ? objectifPrincipal : '--' %>
          </p>
        </div>
        <div class="p-3 bg-blue-100 rounded-full">
          <i class="fas fa-bullseye text-blue-600 text-xl"></i>
        </div>
      </div>
      <p class="mt-4 text-xs text-gray-500">
        Ajustez vos objectifs selon vos priorités
      </p>
    </div>
  </div>

  <% if (typeof error !=='undefined' && error) { %>
    <div class="rounded-lg border border-red-200 bg-red-50 p-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
              d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
              clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <p class="text-sm font-medium text-red-800">
            <%= error %>
          </p>
        </div>
      </div>
    </div>
    <% } %>

      <% if (typeof success !=='undefined' && success) { %>
        <div class="rounded-lg border border-green-200 bg-green-50 p-4">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                  clip-rule="evenodd" />
              </svg>
            </div>
            <div class="ml-3">
              <p class="text-sm font-medium text-green-800">
                <%= success %>
              </p>
            </div>
          </div>
        </div>
        <% } %>

          <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <div class="xl:col-span-2">
              <div class="bg-white rounded-lg shadow">
                <div class="p-6 border-b border-gray-200">
                  <h3 class="text-lg font-semibold text-gray-900">
                    Mettre à jour votre profil
                  </h3>
                  <p class="text-sm text-gray-500">
                    Ces informations nous aident à personnaliser votre programme nutritionnel.
                  </p>
                </div>

                <form action="/user/profil" method="POST" class="p-6 space-y-6">
                  <section class="rounded-xl border border-gray-200 bg-gray-50 p-6 space-y-4">
                    <div class="flex items-center justify-between">
                      <h4 class="text-lg font-semibold text-gray-900">
                        Informations personnelles
                      </h4>
                      <span class="text-sm text-gray-500">
                        Votre identité nutritionnelle
                      </span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label for="sexe" class="block text-sm font-medium text-gray-700">
                          Sexe
                        </label>
                        <select id="sexe" name="sexe" required
                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white">
                          <option value="">Sélectionnez</option>
                          <option value="H" <%=typeof profile !=='undefined' && profile.sexe==='H' ? 'selected' : '' %>>
                            Homme
                          </option>
                          <option value="F" <%=typeof profile !=='undefined' && profile.sexe==='F' ? 'selected' : '' %>>
                            Femme
                          </option>
                        </select>
                      </div>

                      <div>
                        <label for="date_naissance" class="block text-sm font-medium text-gray-700">
                          Date de naissance
                        </label>
                        <input id="date_naissance" name="date_naissance" type="date" required
                          value="<%= typeof profile !== 'undefined' && profile.date_naissance ? new Date(profile.date_naissance).toISOString().split('T')[0] : '' %>"
                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" />
                      </div>
                    </div>
                  </section>

                  <section class="rounded-xl border border-gray-200 bg-gray-50 p-6 space-y-4">
                    <div class="flex items-center justify-between">
                      <h4 class="text-lg font-semibold text-gray-900">
                        Mesures corporelles
                      </h4>
                      <span class="text-sm text-gray-500">
                        Suivez vos évolutions physiques
                      </span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div>
                        <label for="taille_cm" class="block text-sm font-medium text-gray-700">
                          Taille (cm)
                        </label>
                        <input id="taille_cm" name="taille_cm" type="number" step="0.01" min="100" max="250"
                          value="<%= typeof profile !== 'undefined' && profile.taille_cm ? profile.taille_cm : '' %>"
                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                          placeholder="170.5" />
                      </div>

                      <div>
                        <label for="poids_actuel_kg" class="block text-sm font-medium text-gray-700">
                          Poids actuel (kg)
                        </label>
                        <input id="poids_actuel_kg" name="poids_actuel_kg" type="number" step="0.01" min="30" max="300"
                          value="<%= typeof profile !== 'undefined' && profile.poids_actuel_kg ? profile.poids_actuel_kg : '' %>"
                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                          placeholder="70.5" />
                      </div>

                      <div>
                        <label for="poids_cible_kg" class="block text-sm font-medium text-gray-700">
                          Poids cible (kg)
                        </label>
                        <input id="poids_cible_kg" name="poids_cible_kg" type="number" step="0.01" min="30" max="300"
                          value="<%= typeof profile !== 'undefined' && profile.poids_cible_kg ? profile.poids_cible_kg : '' %>"
                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                          placeholder="65.0" />
                      </div>
                    </div>
                  </section>

                  <section class="rounded-xl border border-gray-200 bg-gray-50 p-6 space-y-4">
                    <div class="flex items-center justify-between">
                      <h4 class="text-lg font-semibold text-gray-900">
                        Activité physique
                      </h4>
                      <span class="text-sm text-gray-500">
                        Renseignez vos habitudes sportives
                      </span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label for="niveau_activite" class="block text-sm font-medium text-gray-700">
                          Niveau d'activité
                        </label>
                        <select id="niveau_activite" name="niveau_activite"
                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white">
                          <option value="">Sélectionnez</option>
                          <option value="Sédentaire" <%=typeof profile !=='undefined' &&
                            profile.niveau_activite==='Sédentaire' ? 'selected' : '' %>>
                            Sédentaire
                          </option>
                          <option value="Modéré" <%=typeof profile !=='undefined' && profile.niveau_activite==='Modéré'
                            ? 'selected' : '' %>>
                            Modéré
                          </option>
                          <option value="Actif" <%=typeof profile !=='undefined' && profile.niveau_activite==='Actif'
                            ? 'selected' : '' %>>
                            Actif
                          </option>
                          <option value="Très actif" <%=typeof profile !=='undefined' &&
                            profile.niveau_activite==='Très actif' ? 'selected' : '' %>>
                            Très actif
                          </option>
                        </select>
                      </div>

                      <div>
                        <label for="sport_discipline" class="block text-sm font-medium text-gray-700">
                          Discipline sportive
                        </label>
                        <select id="sport_discipline" name="sport_discipline"
                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white">
                          <option value="Aucun" <%=typeof profile==='undefined' || !profile.sport_discipline ||
                            profile.sport_discipline==='Aucun' ? 'selected' : '' %>>
                            Aucun
                          </option>
                          <option value="Endurance" <%=typeof profile !=='undefined' &&
                            profile.sport_discipline==='Endurance' ? 'selected' : '' %>>
                            Endurance
                          </option>
                          <option value="Force" <%=typeof profile !=='undefined' && profile.sport_discipline==='Force'
                            ? 'selected' : '' %>>
                            Force
                          </option>
                          <option value="Mixte" <%=typeof profile !=='undefined' && profile.sport_discipline==='Mixte'
                            ? 'selected' : '' %>>
                            Mixte
                          </option>
                        </select>
                      </div>

                      <div>
                        <label for="frequence_seances" class="block text-sm font-medium text-gray-700">
                          Fréquence des séances (par semaine)
                        </label>
                        <input id="frequence_seances" name="frequence_seances" type="number" min="0" max="7"
                          value="<%= typeof profile !== 'undefined' && profile.frequence_seances ? profile.frequence_seances : '' %>"
                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                          placeholder="3" />
                      </div>

                      <div>
                        <label for="duree_moyenne_min" class="block text-sm font-medium text-gray-700">
                          Durée moyenne (minutes)
                        </label>
                        <input id="duree_moyenne_min" name="duree_moyenne_min" type="number" min="0" max="300"
                          value="<%= typeof profile !== 'undefined' && profile.duree_moyenne_min ? profile.duree_moyenne_min : '' %>"
                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                          placeholder="60" />
                      </div>

                      <div class="md:col-span-2">
                        <label for="depense_energetique" class="block text-sm font-medium text-gray-700">
                          Dépense énergétique (kcal/jour)
                        </label>
                        <input id="depense_energetique" name="depense_energetique" type="number" min="0" max="5000"
                          value="<%= typeof profile !== 'undefined' && profile.depense_energetique ? profile.depense_energetique : '' %>"
                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                          placeholder="2000" />
                      </div>
                    </div>
                  </section>

                  <section class="rounded-xl border border-gray-200 bg-gray-50 p-6 space-y-4">
                    <div class="flex items-center justify-between">
                      <h4 class="text-lg font-semibold text-gray-900">
                        Objectifs
                      </h4>
                      <span class="text-sm text-gray-500">
                        Fixez vos cibles nutritionnelles
                      </span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label for="objectif" class="block text-sm font-medium text-gray-700">
                          Objectif principal
                        </label>
                        <select id="objectif" name="objectif"
                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white">
                          <option value="">Sélectionnez</option>
                          <option value="Perte poids" <%=typeof profile !=='undefined' &&
                            profile.objectif==='Perte poids' ? 'selected' : '' %>>
                            Perte de poids
                          </option>
                          <option value="Prise masse" <%=typeof profile !=='undefined' &&
                            profile.objectif==='Prise masse' ? 'selected' : '' %>>
                            Prise de masse
                          </option>
                          <option value="Maintien" <%=typeof profile !=='undefined' && profile.objectif==='Maintien'
                            ? 'selected' : '' %>>
                            Maintien
                          </option>
                          <option value="Sport" <%=typeof profile !=='undefined' && profile.objectif==='Sport'
                            ? 'selected' : '' %>>
                            Performance sportive
                          </option>
                          <option value="Pathologie" <%=typeof profile !=='undefined' && profile.objectif==='Pathologie'
                            ? 'selected' : '' %>>
                            Pathologie
                          </option>
                        </select>
                      </div>

                      <div>
                        <label for="calories_cible" class="block text-sm font-medium text-gray-700">
                          Calories cibles (kcal/jour)
                        </label>
                        <input id="calories_cible" name="calories_cible" type="number" min="800" max="4000"
                          value="<%= typeof profile !== 'undefined' && profile.calories_cible ? profile.calories_cible : '' %>"
                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                          placeholder="2000" />
                      </div>

                      <div class="md:col-span-2">
                        <label for="type_pathologie" class="block text-sm font-medium text-gray-700">
                          Type de pathologie (si applicable)
                        </label>
                        <textarea id="type_pathologie" name="type_pathologie" rows="3"
                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                          placeholder="Décrivez votre pathologie si applicable..."><%= typeof profile !== 'undefined' && profile.type_pathologie ? profile.type_pathologie : '' %></textarea>
                      </div>
                    </div>
                  </section>

                  <section class="rounded-xl border border-gray-200 bg-gray-50 p-6 space-y-4">
                    <div class="flex items-center justify-between">
                      <h4 class="text-lg font-semibold text-gray-900">
                        Répartition nutritionnelle (%)
                      </h4>
                      <span class="text-sm text-gray-500">
                        Assurez-vous d'atteindre 100%
                      </span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div>
                        <label for="glucides_pct" class="block text-sm font-medium text-gray-700">
                          Glucides (%)
                        </label>
                        <input id="glucides_pct" name="glucides_pct" type="number" min="0" max="100"
                          value="<%= typeof profile !== 'undefined' && profile.glucides_pct ? profile.glucides_pct : '' %>"
                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                          placeholder="50" />
                      </div>

                      <div>
                        <label for="proteines_pct" class="block text-sm font-medium text-gray-700">
                          Protéines (%)
                        </label>
                        <input id="proteines_pct" name="proteines_pct" type="number" min="0" max="100"
                          value="<%= typeof profile !== 'undefined' && profile.proteines_pct ? profile.proteines_pct : '' %>"
                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                          placeholder="20" />
                      </div>

                      <div>
                        <label for="lipides_pct" class="block text-sm font-medium text-gray-700">
                          Lipides (%)
                        </label>
                        <input id="lipides_pct" name="lipides_pct" type="number" min="0" max="100"
                          value="<%= typeof profile !== 'undefined' && profile.lipides_pct ? profile.lipides_pct : '' %>"
                          class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                          placeholder="30" />
                      </div>
                    </div>
                    <p class="text-sm text-gray-500">
                      La somme des pourcentages doit être égale à 100%.
                    </p>
                  </section>

                  <div class="flex flex-col sm:flex-row gap-4">
                    <button type="submit"
                      class="flex-1 flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                      Enregistrer le profil
                    </button>

                    <a href="/dashboard"
                      class="flex-1 flex justify-center py-3 px-4 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                      Annuler
                    </a>
                  </div>
                </form>
              </div>
            </div>

            <div class="space-y-6">
              <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900">Résumé rapide</h3>
                <dl class="mt-4 space-y-4">
                  <div class="flex items-start justify-between">
                    <dt class="text-sm text-gray-500">Niveau d'activité</dt>
                    <dd class="text-sm font-medium text-gray-900">
                      <%= activityLevel || 'À définir' %>
                    </dd>
                  </div>
                  <div class="flex items-start justify-between">
                    <dt class="text-sm text-gray-500">Discipline sportive</dt>
                    <dd class="text-sm font-medium text-gray-900">
                      <%= sportDiscipline || 'Non renseigné' %>
                    </dd>
                  </div>
                  <div class="flex items-start justify-between">
                    <dt class="text-sm text-gray-500">Poids cible</dt>
                    <dd class="text-sm font-medium text-gray-900">
                      <%= poidsCible ? poidsCible + ' kg' : 'À définir' %>
                    </dd>
                  </div>
                  <div class="flex items-start justify-between">
                    <dt class="text-sm text-gray-500">Objectif principal</dt>
                    <dd class="text-sm font-medium text-gray-900">
                      <%= objectifPrincipal || 'À déterminer' %>
                    </dd>
                  </div>
                </dl>
              </div>

              <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold text-gray-900">Conseils rapides</h3>
                <ul class="mt-4 space-y-3 text-sm text-gray-600">
                  <li class="flex items-start space-x-3">
                    <span class="mt-1 h-2 w-2 rounded-full bg-indigo-500"></span>
                    <span>Mettre à jour votre profil chaque mois pour suivre vos progrès.</span>
                  </li>
                  <li class="flex items-start space-x-3">
                    <span class="mt-1 h-2 w-2 rounded-full bg-indigo-500"></span>
                    <span>Adaptez votre objectif calorique en fonction de votre activité hebdomadaire.</span>
                  </li>
                  <li class="flex items-start space-x-3">
                    <span class="mt-1 h-2 w-2 rounded-full bg-indigo-500"></span>
                    <span>Vérifiez la cohérence de votre répartition nutritionnelle avant de valider.</span>
                  </li>
                </ul>
              </div>
            </div>
          </div>


          <script>
            (function () {
              const tailleInput = document.getElementById('taille_cm');
              const poidsInput = document.getElementById('poids_actuel_kg');
              const glucidesInput = document.getElementById('glucides_pct');
              const proteinesInput = document.getElementById('proteines_pct');
              const lipidesInput = document.getElementById('lipides_pct');
              const form = document.querySelector('form');

              function calculateIMC() {
                const taille = parseFloat(tailleInput?.value);
                const poids = parseFloat(poidsInput?.value);

                if (taille && poids) {
                  const imc = poids / ((taille / 100) ** 2);
                  // L'IMC sera calculé côté serveur
                  return imc;
                }

                return null;
              }

              function validateNutrition() {
                const glucides = parseInt(glucidesInput?.value, 10) || 0;
                const proteines = parseInt(proteinesInput?.value, 10) || 0;
                const lipides = parseInt(lipidesInput?.value, 10) || 0;

                const total = glucides + proteines + lipides;

                if (total !== 100 && total > 0) {
                  alert('La somme des pourcentages nutritionnels doit être égale à 100%');
                  return false;
                }

                return true;
              }

              if (tailleInput && poidsInput) {
                tailleInput.addEventListener('input', calculateIMC);
                poidsInput.addEventListener('input', calculateIMC);
              }

              if (form) {
                form.addEventListener('submit', function (e) {
                  if (!validateNutrition()) {
                    e.preventDefault();
                  }
                });
              }
            })();
          </script>